<!--
Copyright (C) Shrumit Mehta 2016. All rights reserved.
-->

<!doctype html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<title>Timetable Maker</title>

	<!-- Fonts -->
	<link href="https://fonts.googleapis.com/css?family=Open+Sans|Neuton" rel="stylesheet">

	<!-- PureCSS -->
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pure/0.6.0/pure-min.css">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pure/0.6.0/grids-responsive-min.css">

	<!-- jQuery -->
	<script src="https://code.jquery.com/jquery-2.2.4.min.js" integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44=" crossorigin="anonymous"></script>

	<!-- Handlebars.js -->
	<script src="https://cdnjs.cloudflare.com/ajax/libs/handlebars.js/4.0.5/handlebars.min.js"></script>
	
	<!-- Select2 -->
	<link rel="stylesheet" type="text/css" href= "https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.3/css/select2.min.css">
	<script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.3/js/select2.min.js"></script>
	

	<style>
		
		html {
			background-color: #E6E6E6;
			min-height: 100%;
		overflow: auto;
		}
		
		body {
			width: 90%;
			max-width: 1080px;
			padding: 1% 2.5%;
			margin: 0.5rem auto 1rem auto;
			background:white;
			box-shadow: 0 10px 20px rgba(0,0,0,0.19), 0 6px 6px rgba(0,0,0,0.23);
		}
		
		html, button, input, select, textarea, .pure-g [class *= "pure-u"] {
			font-family: 'Open Sans', sans-serif;
		}
		
		h1, h3 {
			font-family: 'Neuton', serif;
		}
		
		header {
			text-align: center;
			border-bottom: 1px solid #4F2683;
		}
		
		h1{
			font-weight: normal;
			color: #4F2683;
			font-size: 3em;
			margin: 0.1em auto;
		}
		
		h3 {
			font-weight: normal;
			font-size: 1.5em;
			color: black;
		}
		
		label {
			cursor: pointer;
			cursor: hand;
			
		}
		
		li {
			margin-bottom: 0.2em;
		}
		
		.toggle {
			width: 100px;
		}
		
		.right {
			amargin-top: 0.5em;
			amargin-bottom: 0.5em;
			float: right;
		}
		
		.pure-button {
			box-shadow: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24);
			min-width: 100px;
		 }
		
		.pure-button-active {
			font-weight: bold;
			atext-decoration: underline;
			background-color: #F2F2F2;
			color: #4F2683;
			color: black;
		}
		
		.pure-button-hover, .pure-button:hover, .pure-button:focus {
			background-color: #F2F2F2;
			background-image: none;
		}

		.pure-button-primary {
			background-color: #4F2683;
		}

		.pure-button-primary:hover {
			background-color: #4F2689;
			text-decoration: underline;
		}
		
		.pure-button-primary:active {
			cursor: wait;
		}

		.pure-menu-list {
			margin: 0.5em auto;
			text-align: center;
		}

		.pure-menu-link:hover {
			atext-decoration: line-through;
			background-color: #F5F5F5;
			border-radius: 2px
		}
		
		.list-item {
			display: flex;
			justify-content: flex-end;
			aflex-grow: 1;
			background: #E6E6E6;
			box-shadow: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24);
			border-radius: 2px;
			margin: 2px;
		}
		
		.list-title{
			flex-grow: 1;
			text-overflow: ellipsis;
			overflow: hidden;
			display: block;
			color: #2E2E2E;
		}
		
		.list-cross{
			max-width: 100px;
			border-left: 2px dashed #F5F5F5;
		}
		
		.section-div {
			display: none;
			acolor: #777777;
		}
		
		.sections-table {
			text-align: left;
			letter-spacing: 0em;
			border: 0.191em solid #F5F5F5;
		}

		.sections-table td {
			padding: 0.1em 0.5em;
			border: 1px solid #dfdfdf;
		}

		.center-button {
			margin: 0 auto;
			display: flex;
			justify-content: center;
		}

		.select2 {
			margin: 0.5em auto;
		}
		
		.select2-dropdown {
			font-size: 80%;
			font-weight: lighter;
		}
				
		.select2-container--default .select2-selection--single {
			border-radius: 0px;
			text-align: center;
			border: 1px	black dashed;
			outline: none;
			font-size: 80%;
			cursor: text;
		}
				
		.select2-container--default .select2-selection--single .select2-selection__placeholder {
			color: black;
		}
		
		#timetable-div {
			width: 100%;
			display: flex;
			flex-wrap: wrap;
			justify-content: center;
		}
		
		.timetable-container {
			overflow: auto;
			text-align: center;
			margin: 1em 0.25em;
		}
		
		.timetable {
			border-collapse: collapse;
			border: 1px solid black;
			font-size: 80%;
		}
		
		.timetable td, .timetable th {
			border: 1px solid black;
			padding: 0px 0.5em;
			min-width: 50px;
			white-space: nowrap;
		}

		.timetable tr:nth-child(even) {
			background-color: #F2F2F2;
		}

	</style>

	<script>
		
	var course_selc = [];
	$(document).ready(function() {

		let term = -1; // flag for term selected
		let selc = []; // selected courses id
		let timePref = 1; //late/early class preference; default: 1=late

		let url = window.location.origin;

		// Remove :focus from button
		$("button").click(function() {
			$(this).blur();
		});

		// Load search boxes and make hidden
		(function loadSelect() {
			const termNames = ['first term', 'second term']; // stores term names

			for (i = 0; i < 2; i++) {
				let selector = `select[data-id=${i}]`;
				let placeholdertext = `Search for ${termNames[i]} and full year courses`;
				$.getJSON(`${url}/search/${i}`, function(res) {
					$(selector).empty().append("<option></option>");
					$(selector).select2({
						data: res,
						placeholder: placeholdertext,
						minimumInputLength: 2
					})
					$("#select-div" + i).hide();
				})
			}
		})()

		// Toggle select2 visibility
		function toggleSelect() {
			$("#select-div" + term).show();
			// $("#select"+(1-term)).select2('val', null);
			$("#select-div" + (1 - term)).hide();
		}

		// Toggle Fall/Winter terms
		$(".toggle").click(function() {
			var button = $(this).attr('data-id');
			if (term == button)
				return;

			term = button;
			toggleSelect();
			$('#clear').click();

			switch (button) {
				case "0":
					$("#winter").removeClass("pure-button-active");
					$("#fall").addClass("pure-button-active");
					break;
				case "1":
					$("#fall").removeClass("pure-button-active");
					$("#winter").addClass("pure-button-active");
					break;
			}

		});

		// Set Fall as default term
		$("#fall").click();

		var solutions;
		// Remove course from list
		$('ul').on('click', '.list-cross', function() {

			index = selc.indexOf($(this).closest('li').attr("data-id"));
			selc.splice(index, 1);
			course_selc.splice(index, 1);
			$(this).closest('li').remove();
			return false;
		});

		// Expand sections div
		$('ul').on('click', '.list-title', function() {
			$(this).blur();
			id = $(this).closest('li').attr('data-id');
			// if ($(`.section-div[data-id=${id}]`).css('display') == 'none')
			// $('.section-div').css('display', 'none');
			$(`.section-div[data-id=${id}]`).slideToggle(100);
			return false;
		});

		// Clear All button
		$('#clear').on('click', function() {
			selc = [];
			course_selc = [];
			$('#list').empty();
		});

		//About button to display footer
		$('#about').click(function() {
			$('footer').slideToggle(100);
		});

		// Add course button
		$('#add').click(function() {
			$(this).blur();

			// check for emptiness or duplicacy
			id = $('#select' + term).select2('data')[0].id;
			if ((id == "") || (selc.indexOf(id) != -1))
				return;

			selc.push(id);

			$.getJSON(`${url}/api/${id}`, function(data) {
				$('#list').append(sec_template(data));
				course_selc.push(data);
			});

		});
		
		$('#time-pref-form input').change(function(){
			timePref =	$(this).val();
		});
		
		$('#more').click(function(){
			if (solutions.length > 0){
				makeTimetables();
			}
		});

		// Compile Handlebars
		let template = $('#list-template').html();
		let sec_template = Handlebars.compile(template);

		template = $('#timetable-template').html();
		let table_template = Handlebars.compile(template);

		template = $('#row-template').html();
		let row_template = Handlebars.compile(template);


		// COMPUTE!
		$('#compute').click(function() {
			$('#timetable-div').html('');
			$('#more').hide();
			$('#info-text').text("");
			if (course_selc.length > 0) {
				//$('#compute').prop('disabled');
				let start = new Date().getTime();
				let count = computeEngine();
				let end = new Date().getTime();
				console.log(`Took ${end-start} ms.`);
				$('#info-text').text(`${count} conflict-free timetables possible. Computed in ${end-start}ms.`);
				makeTimetables();
			}
		});

		// Compute Logic
		function computeEngine() {
			'use strict';

			// CREATE MASTER
			let master = [];
			for (let i = 0; i < course_selc.length; i++) {
				for (let j = 0; j < course_selc[i].components.length; j++)
					master.push(JSON.parse(JSON.stringify(course_selc[i].components[j].sections)));
			}

			// remove disabled sections
			for (let i = 0; i < master.length; i++) {
				master[i] = master[i].filter(function(sec) {
					print(sec);
					if (sec.hasOwnProperty("disabled") && sec.disabled === true){
						return false;
					}
					else{
						return true;
					}
				});
			}

			// SORT MASTER - lowest # of sections first
			master.sort(function(a, b) {
				return a.length - b.length;
			})
			

			// HEURISTIC for score threshold
			let thresholds = [0, 3, 2.25, 1.7, 1.55, 1.3, 1.2, 1.05, 1]
			let level = 0;
			let bar;
			let maxperm = 1;
			for (let i = 0; i < master.length; i++) {
				maxperm *= master[i].length;
			}
			if (maxperm > 10000000) {
				level = 1;
			}
			bar = thresholds[level];

			// INITIALIZE
			let stack = [];
			let table = [0, 0, 0, 0, 0];
			solutions = [];
			let index = 0;
			let count = 0;

			console.log('running with bar ' + bar);
			recurse();

			// HEURISTIC RE-RUN
			while (solutions.length < 50 && bar > 0) {
				bar = thresholds[++level];
				stack = [];
				table = [0, 0, 0, 0, 0];
				solutions = [];
				index = 0;
				count = 0;
				console.log('repeating with bar ' + bar);
				recurse();
			}

			// SORT SOLUTIONS
			solutions.sort(function(a, b) {
				return a.score - b.score;
			});

			//print(solutions[solutions.length - 1]);
			//print(solutions);
			console.log('max perms ' + maxperm);
			console.log('con-free perms ' + count);
			console.log('solutions ' + solutions.length);
			return count;
			// ------------------------------------------------------//
			function recurse() {
				if (index === master.length) {
					snapshot();
					return
				}
				for (let i = 0; i < master[index].length; i++) {
					stack.push(master[index][i]);
					if (isConflict()) {
						stack.pop();
					} else {
						addToTable();
						index += 1;
						recurse();
						index -= 1;
						removeFromTable();
						stack.pop();
					}
				}
				return;
			}

			function snapshot() {
				count++;
				// compute score
				let score = 1;
				let total = 0;
				for (let i = 0; i < 5; i++) {
					if (table[i] === 0) {
						score++;
					} else {
						total += Math.log(table[i]);
					}
				}
				//console.log(total / (5 - score) / 28);
				//timePref is used to swtch between early classes and late classes
				score +=	timePref * ((total / (5 - score)) / 28);
				
				// test bar
				if (score < bar)
					return;

				// push to solutions
				let slots = [];
				for (let i = 0; i < stack.length; i++) {
					for (let j = 0; j < stack[i].timeslots.length; j++) {
						let obj = stack[i].timeslots[j];
						slots.push({
							id: obj.id,
							day: obj.day,
							start: obj.start,
							len: obj.len,
							str1: obj.str1,
							str2: obj.str2
						});
					}
				}
				solutions.push({
					score,
					slots
				});
			}

			function isConflict() {
				let section = stack[stack.length - 1];
				for (let j = 0; j < section.timeslots.length; j++) {
					if ((table[section.timeslots[j].day] & section.timeslots[j].timebit) > 0) {
						return true;
					}
				}
				return false;
			}

			function addToTable() {
				let section = stack[stack.length - 1];
				for (let j = 0; j < section.timeslots.length; j++) {
					table[section.timeslots[j].day] = table[section.timeslots[j].day] ^ section.timeslots[j].timebit;
				}
			}

			function removeFromTable() {
				let section = stack[stack.length - 1];
				for (let j = 0; j < section.timeslots.length; j++) {
					table[section.timeslots[j].day] = (~section.timeslots[j].timebit) & table[section.timeslots[j].day];
				}
			}
		}

		function makeTimetables() {
			const time_text = ["8:00 am", "8:30 am", "9:00 am", "9:30 am", "10:00 am", "10:30 am", "11:00 am", "11:30 am", "12:00 pm", "12:30 pm", "1:00 pm", "1:30 pm", "2:00 pm", "2:30 pm", "3:00 pm", "3:30 pm", "4:00 pm", "4:30 pm", "5:00 pm", "5:30 pm", "6:00 pm", "6:30 pm", "7:00 pm", "7:30 pm", "8:00 pm", "8:30 pm", "9:00 pm", "9:30 pm", "10:00 pm"];
			console.log('making tt');
			// generate table
			let counter = 0;
			while (counter < 10 && solutions.length > 0) {
				let current = solutions.pop()
				let index = solutions.length;
				$('#timetable-div').append(table_template({
					id: index
				}));
				
				// insert rows and time column
				for (let i = 0; i < 28; i++) {
					$(`table[data-id=${index}] > tbody`).append(row_template({
						time: time_text[i],
						rowindex: i,
						index: index
					}));
				}
				current.slots.forEach(function(slot){
					let row = slot.start + i
					//get integer quotient of len/2 to adjust text to middle
					let quotient = ((slot.len)/2 | 0) - 1;
					for (let i = 0; i < slot.len; i++){
						$cell = $(`#ttr-${index}-${slot.start+i} td:nth-child(${slot.day+2})`);
						$cell.css('border-top', 'none');
						$cell.css('border-bottom', 'none');
						
						// Display slot text
						if (i === 0)
							$cell.css('border-top', '1px solid black');
						if (i === (0 + quotient))
							$cell.text(slot.str1);
						else if (i == (1 + quotient))
							$cell.text(slot.str2);
						else
							$cell.text(" ");
						
						$cell.css('background-color', `rgb(${255-(slot.id*7)%151},${255-(slot.id*7)%101},${255-(slot.id*7)%53})`);
					}
				})
				
				//print(current);
				counter++;
			}
			if (solutions.length > 0)
				$('#more').show();
			
		}

	}); //end of document.ready

	function checkboxChange(elem) {
		$elem = $(elem);
		var index = ($elem.closest('li').index());
		var mid = $elem.closest('td').attr('mid');
		var sid = $elem.attr('sid');

		var value = $elem.is(':checked') ? false : true;
		course_selc[index].components[mid].sections[sid]["disabled"] = value;

		//print(course_selc));

	}

	function print(obj) {
		console.log(JSON.stringify(obj));
	}
	</script>
		
	<!-- Sections Template -->
	<script id="list-template" type="text/x-handlebars-template">
		<li class="pure-menu-item" data-id="{{id}}">
			<div class="list-item">
				<a href="#" class="pure-menu-link list-title">
					{{text}}
				</a>
				<a href="#" class="pure-menu-link list-cross">
					X
				</a>
			</div>
			<div class="section-div" data-id="{{id}}">
				<table class="sections-table">
				{{#each components}}
				<tr>
					<td style="font-style:italic; width: 75px; text-align: left">{{name}}</td>
					<td class="section-td" mid="{{@index}}">
							{{#each sections}}
							<input onchange="checkboxChange(this)" type="checkbox" sid="{{@index}}" id="c{{../../id}}m{{@../index}}s{{@index}}" checked>
							<label for="c{{../../id}}m{{@../index}}s{{@index}}">{{name}}</label>
							{{/each}}
					</td>
				</tr>
				{{/each}}
				</table>
			</div>
		</li>
	</script>
	
	<!-- Table Template -->
	<script id="timetable-template" type="text/x-handlebars-template">
		<div class="timetable-container">
		<table class="timetable" data-id="{{id}}">
			<thead>
				<tr>
					<th>Time</th>
					<th>Mon</th>
					<th>Tue</th>
					<th>Wed</th>
					<th>Thu</th>
					<th>Fri</th>
				</tr>
			</thead>
			<tbody>
			</tbody>
		</table>
		</div>
		<br>
	</script>
	
	<!-- Row Template -->
	<script id="row-template" type="text/x-handlebars-template">
		<tr id="ttr-{{index}}-{{rowindex}}">
			<td>{{time}}</td>
			<td></td><td></td><td></td><td></td><td></td>
		</tr>
	</script>
	
</head>

<body>

	<header>
		<h1>Western Timetable Maker <span style="font-size: 1rem;">BETA</span></h1>
	</header>

	<h3>Instructions</h3>
	<div id="instructions">
		<ol>
			<li>Select a semester, search for a course and add it to the list.</li>
			<li>Click on a course in the list to select its sections.</li>
			<li>Set your preferences. At this time, <em>Most days off</em> cannot be changed. <em>Most days off</em> is given precedence over <em>Late/Early classes</em>.</li>
			<li>Click "Compute!" to generate timetables.</li>
			<li>Timetables appear sorted by preference.</li>
		</ol>
		<ul style="font-size: 80%;">
			<li>Some first year science and social-science courses have upwards of 30 lab/tutorial sections each. Timetables comprising of many such courses can have millions of conflict-free permutations. These might take some time to compute. Be patient!</li>
			<li>Using Chrome, Chromium or Opera is recommended for best stability, especially with first year timetables (see above).</li>
		</ul>
	</div>

	<!-- Main Controls -->
	<div class="pure-g first-grid">
		<!-- Left Panel -->
		<div class="pure-u-1 pure-u-sm-1-3">
			
			<!-- Semester -->
			<h3>Semester</h3>
			<button id="fall" class="toggle pure-button" data-id=0>Fall</button>
			<button id="winter" class="toggle pure-button" data-id=1>Winter</button>
			<br>
			<br>
			
			<!-- Preferences -->
			<h3 style="margin-bottom: 0;">Preferences</h3>
			<div class="pure-g">
				<div class="pure-u-1 pure-u-md-1-2 prefs">
					<form>
						<input id="spread-off" type="radio" class="big-radio" name="spread" value="0" checked disabled>
						<label for="spread-off" disabled>Most days off</label>
						<br>
						<input id="spread-even" type="radio" class="big-radio" name="spread" value="1" disabled>
						<label for="spread-even" disabled>Even spread</label>
					</form>
				</div>
				<div class="pure-u-1 pure-u-md-1-2 prefs">
					<form id="time-pref-form">
						<input id="class-late" type="radio" name="late" value="1" checked>
						<label for="class-late">Late classes</label>
						<br>
						<input id="class-early" type="radio" name="late" value="-1">
						<label for="class-early">Early classes</label>
					</form>
				</div>
			</div>
			
			<br>
		</div>

			<!-- Right Panel -->
		<div class="pure-u-1 pure-u-sm-2-3">
			
			<h3>Courses</h3>
			<ul id="list" class="pure-menu-list">
			</ul>

			<button id="clear" class="pure-button right">Clear All</button>
			<div id="select-div0">
				<select style="width: 100%;" id="select0" data-id=0><option></option>
				</select>
			</div>
			<div id="select-div1">
				<select style="width: 100%;" id="select1" data-id=1><option></option>
				</select>
			</div>
			<button id="add" class="pure-button right">Add</button>
		</div>
	</div>
	<br>

	<button id="compute" class="pure-button pure-button-primary center-button">Compute!</button>
	<p id="info-text"></p>
	<div id="timetable-div"></div>
	<button id="more" class="pure-button center-button" style="display: none;">More</button>
	
	<!-- Footer -->
	<a href="#about" id="about">About</a>
	<footer style="display: none; border-top: 1px solid #4F2683; margin: 1em auto; text-align: center; color: #4F2683;">
		<p>Copyright © 2016 Shrumit Mehta</p>
	</footer>

</body>
